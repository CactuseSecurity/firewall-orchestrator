# this playbook sets up the api
- name: remove api home
  file:
    path: "{{ api_home }}"
    state: absent
  become: yes

- name: create api home
  file:
    path: "{{ api_home }}"
    state: directory
    mode: "0755"
    owner: "{{ fworch_user }}"
    group: "{{ fworch_group }}"
  become: yes

- name: install acl
  package:
    name: acl
    state: present
  become: yes

- name: install apache2
  import_tasks: api-apache-install-and-setup.yml

- name: hasura install 
  import_tasks: hasura-install.yml

- name: settings grants for hasura schema old ansible
  include_tasks: grants-ansible-pre2.10.yml
  when: ansible_version.string is version_compare('2.10', '<')

- name: settings grants for hasura schema new ansible
  include_tasks: grants-ansible-2.10.yml
  when: ansible_version.string is version_compare('2.10', '>=')

- name: include upgrade script
  import_tasks: run-upgrades.yml
  when: "installation_mode == 'upgrade'"

- name: copy fworch config export and import scripts
  copy:
    src: scripts
    dest: "{{ fworch_home }}"
    mode: "0755"
    owner: "{{ fworch_user}}"
    group: "{{ fworch_user}}"
  become: yes

- name: api create documentation
  import_tasks: api-create-docu.yml
  when: api_docu | bool
- name: remove api home
  file:
    path: "{{ api_home }}"
    state: absent
  become: yes
