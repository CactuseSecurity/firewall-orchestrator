@page "/help/API/reporting"
@model FWO.Ui.Pages.Help.MainModel
@{
    Layout = "HelpLayout";
}
@section sidebar{
    @{ 
        await Html.RenderPartialAsync("HelpAPISidebar.cshtml"); 
    }
}
@using FWO.Config.Api
@inject UserConfig userConfig

<div class="p-2">
    <h3>@userConfig.GetText("reporting")</h3>
    
    @userConfig.GetText("H6904")
    <br>

    <ol>
        <li>@userConfig.GetText("H6901")</li>
        <li>@userConfig.GetText("H6906")</li>
        <pre class="code-block" data-lang="bash"><code>
curl --request POST \
    --url https://localhost:8888/api/AuthenticationToken/GetTokenPair/ \
    --header 'content-type: application/json' \
    --data '{"Username": "reportingscheduler", "Password": "xxx"}'
        </code></pre>

        <pre class="code-block" data-lang="text"><code>
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
        </code></pre>    

        <li>@userConfig.GetText("H6905")</li>
        <pre class="code-block" data-lang="bash"><code>
curl --request POST \
    --url https://localhost:9443/api/v1/graphql \
    --header 'content-type: application/json' \
    --header 'x-hasura-role: reporter-viewall' \
    --header 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...' \
    --data '
    {
    "variables": { "userName": "repsched" },
    "query": "query getIDs($userName:String!) { report_template { report_template_id report_template_name } uiuser(where:{uiuser_username:{_eq: $userName}}){ uiuser_id uiuser_username } }"}'
        </code></pre>

        <pre class="code-block" data-lang="json"><code>
{
    "data": {
        "report_template": [
            {
                "report_template_id": 1,
                "report_template_name": "Current Rules"
            },
            {
                "report_template_id": 2,
                "report_template_name": "This year's Rule Changes"
            },
            {
                "report_template_id": 3,
                "report_template_name": "Basic Statistics"
            },
            {
                "report_template_id": 4,
                "report_template_name": "Compliance: Pass rules with ANY"
            },
            {
                "report_template_id": 5,
                "report_template_name": "Current NAT Rules"
            },
            {
                "report_template_id": 6,
                "report_template_name": "current rules cactus sting"
            }
        ],
        "uiuser": [
            {
                "uiuser_id": 7,
                "uiuser_username": "repsched"
            }
        ]
    }
}
        </code></pre>
        <li>@userConfig.GetText("H6902")</li>
        <pre class="code-block" data-lang="bash"><code>
curl --request POST \
    --url https://localhost:9443/api/v1/graphql \
    --header 'content-type: application/json' \
    --header 'x-hasura-role: reporter-viewall' \
    --header 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...' \
    --data '
    {
    "variables": 
        {
            "report_schedule_name": "test-report-api-repsched1251",
            "report_schedule_owner_id": 7,
            "report_schedule_template_id": 6,
            "report_schedule_start_time": "2021-11-19 12:51",
            "report_schedule_repeat": 1,
            "report_schedule_every": 2,
            "report_schedule_active": true,
            "report_schedule_formats": {"data": [{"report_schedule_format_name": "json"},{"report_schedule_format_name": "pdf"}]}
        },
    "query": "mutation addReportSchedule($report_schedule_name: String!, $report_schedule_owner_id: Int!, $report_schedule_template_id: Int!, $report_schedule_start_time: timestamp!, $report_schedule_repeat: Int!, $report_schedule_every: Int!, $report_schedule_active: Boolean!, $report_schedule_formats: report_schedule_format_arr_rel_insert_input!) { insert_report_schedule(objects: {report_schedule_name: $report_schedule_name, report_schedule_owner: $report_schedule_owner_id, report_schedule_start_time: $report_schedule_start_time, report_schedule_repeat: $report_schedule_repeat, report_schedule_every: $report_schedule_every, report_template_id: $report_schedule_template_id, report_schedule_active: $report_schedule_active, report_schedule_formats: $report_schedule_formats}) { returning { report_schedule_id } } } "}'

        </code></pre>

        <pre class="code-block" data-lang="json"><code>
{
    "data": {
        "insert_report_schedule": {
            "returning": [
                {
                    "report_schedule_id": 40
                }
            ]
        }
    }
}
        </code></pre>            

        <li>@userConfig.GetText("H6903")</li>
        <pre class="code-block" data-lang="bash"><code>
curl --request POST \
    --url https://localhost:9443/api/v1/graphql \
    --header 'content-type: application/json' \
    --header 'x-hasura-role: reporter-viewall' \
    --header 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...' \
    --data '
    {
      "variables": { "reportScheduleId": 5 },
      "query": "query reportsBySchedule($reportScheduleId: bigint!) { report_schedule(where: {report_schedule_id: {_eq: $reportScheduleId}}) { report_schedule_id report_schedule_name report_template { latest_report: reports(order_by: {report_id: desc}, limit: 1) { report_id report_name report_start_time report_json }}}}"}'
        </code></pre>

        <pre class="code-block" data-lang="json"><code>
{
  "data": {
    "report_schedule": [
      {
        "report_schedule_id": 2,
        "report_schedule_name": "reportNew",
        "report_template": {
          "latest_report": [
            {
              "report_id": 4,
              "report_name": "reportNew_07.07.2022",
              "report_start_time": "2022-07-07T15:09:13.900092",
              "report_json": "[snip]"
            }
          ]
        }
      }
    ]
  }
}
        </code></pre>
    </ol>
</div>
