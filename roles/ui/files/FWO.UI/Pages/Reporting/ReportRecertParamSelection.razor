@inject ApiConnection apiConnection
@inject UserConfig userConfig


<div class="p-3">
    <h5 class="text-left">@(userConfig.GetText("recert_parameter"))</h5>
    <h7 class="text-left text-white">@(userConfig.GetText("due_within")):</h7>
    <input type="number" min="1" max="5000" step="1" class="form-control form-control-sm" @bind="RecertFilter.RecertificationDisplayPeriod" />
    @if(ReportType != ReportType.OwnerRecertification)
    {
        <h7 class="text-left text-white">@(userConfig.GetText("owner"))</h7>
        <Dropdown ElementType="FwoOwner" ElementToString="@(o => o.Name)" Nullable="false" SelectedElement="selectedOwner" 
                SelectedElementChanged="SelectedOwnerChanged" Elements="ownerList">
            <ElementTemplate Context="owner">
                @owner.Name
            </ElementTemplate>
        </Dropdown>
        <br>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="recertShowAnyMatch"
                @bind="RecertFilter.RecertShowAnyMatch"
                @oninput="@(async () =>
                { 
                    RecertFilter.RecertShowAnyMatch = !RecertFilter.RecertShowAnyMatch;
                    if (!RecertFilter.RecertShowAnyMatch) 
                    {
                        if (FilterInput.Length > 0)
                        {
                            FilterInput += " and (not src==0.0.0.0 and not dst==0.0.0.0)";
                        }
                        else
                        {
                            FilterInput = "(not src==0.0.0.0 and not dst==0.0.0.0)";
                        }
                    }
                    else 
                    {
                        FilterInput =  FilterInput.Replace("and (not src==0.0.0.0 and not dst==0.0.0.0)", string.Empty);
                        FilterInput =  FilterInput.Replace("(not src==0.0.0.0 and not dst==0.0.0.0)", string.Empty);
                    }
                    await FilterInputChanged.InvokeAsync(FilterInput);
                })" />
            <label class="form-check-label text-white" for="recertShowAnyMatch">@(userConfig.GetText("show_any_match"))</label>
        </div>
    }
</div>


@code
{
    [CascadingParameter]
    Action<Exception?, string, string, bool> DisplayMessageInUi { get; set; } = DefaultInit.DoNothing;

    [Parameter]
    public string FilterInput { get; set; } = "";

    [Parameter]
    public EventCallback<string> FilterInputChanged { get; set; }

    [Parameter]
    public RecertFilter RecertFilter { get; set; } = new();

    [Parameter]
    public EventCallback<RecertFilter> RecertFilterChanged { get; set; }

    [Parameter]
    public ReportType ReportType { get; set; } = ReportType.Recertification;

    private List<FwoOwner> ownerList = [];
    private FwoOwner? selectedOwner;
    private bool ownerSet = false;
    private const int AllId = -1;
    private const int UnselectedId = -2;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            ownerList = await apiConnection.SendQueryAsync<List<FwoOwner>>(OwnerQueries.getOwners);
            if(ownerList.Count > 0)
            {
                ownerList.Add(new(){ Id = AllId, Name = userConfig.GetText("all")});
                ownerList = [.. ownerList.OrderBy(o => o.Id)];
            }
            else
            {
                DisplayMessageInUi(null, userConfig.GetText("no_owners"), "", true);
            }
            RecertFilter.RecertificationDisplayPeriod = Convert.ToInt32(userConfig.RecertificationDisplayPeriod);
            selectedOwner = new(){ Id = UnselectedId };
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("object_fetch"), "", true);
        }
    }

    protected override void OnParametersSet()
    {
        if(!ownerSet)
        {
            ownerSet = true;
            InitOwner();
        }
    }

    private void InitOwner()
    {
        if(RecertFilter.RecertOwnerList.Count > 0 && !CheckForAll())
        {
            FwoOwner? preselectedOwner = ownerList.FirstOrDefault(o => o.Id == RecertFilter.RecertOwnerList[0]);
            if (preselectedOwner != null)
            {
                selectedOwner = preselectedOwner;
                return;
            }
        }
        if (ownerList.Count > 0)
        {
            selectedOwner = ownerList[0];
        }
    }

    private bool CheckForAll()
    {
        return !ownerList.Select(o => o.Id).Where(id => id >= 0).Any(x => !RecertFilter.RecertOwnerList.Contains(x));
    }

    private void SelectedOwnerChanged(FwoOwner newOwner)
    {
        selectedOwner = newOwner;
        if(newOwner.Id == AllId)
        {
            RecertFilter.RecertOwnerList = [.. ownerList.Select(o => o.Id).Where(id => id >= 0)];
        }
        else if(newOwner.Id == UnselectedId)
        {
            RecertFilter.RecertOwnerList = [];
        }
        else
        {
            RecertFilter.RecertOwnerList = [newOwner.Id];
        }
    }
}
