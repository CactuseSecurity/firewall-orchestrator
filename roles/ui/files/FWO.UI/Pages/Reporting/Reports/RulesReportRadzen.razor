@inject UserConfig userConfig
@using FWO.Report
@using FWO.Ui.Display

<TreeTable TItem="MyData" Headers="Headers" Nodes="treeData">
    <CellTemplate Context="item">
        @item.Name
    </CellTemplate>
</TreeTable>

@code {
    [Parameter]
    public ReportType SelectedReportType { get; set; }

    [Parameter]
    public List<ManagementReport> Managements { get; set; } = new();
    private NatRuleDisplayHtml? RuleDisplay;
    private bool Recertification { get; set; } = false;

    private bool Loading { get; set; }

    #region Radzen UI Boilerplate
    private RadzenDataGrid<Rule> RulesGrid;    
    private bool? GroupsExpanded { get; set; } = false;
    #endregion

    List<Rule> Rules;
    List<string> Headers = new List<string>() { "No.", "Name", "Source", "Destination" };

    List<TreeNode<MyData>> treeData;

    class MyData
    {
        public string Name { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await ShowLoading();

        RuleDisplay = new NatRuleDisplayHtml(userConfig);

        var management = Managements.Select(mgt => new ManagementReportController(mgt)).First();
        var device = management.Devices.Select(dev => DeviceReportController.FromDeviceReport(dev)).First();

        var ungroupedRules = ReportRules.GetAllRulesOfGateway(device, management);

        Rules = ungroupedRules.ToList();

        treeData = new List<TreeNode<MyData>>
        {
            new TreeNode<MyData> {
                Item = new MyData { Name = "pre Stealth rule (3-10)" },
                Children = new List<TreeNode<MyData>> {
                    new TreeNode<MyData> {
                        Item = new MyData { Name = "4" }                        
                    }
                }
            },
            new TreeNode<MyData> {
                Item = new MyData { Name = "test & tmp -rules (12-22)" },
                Children = new List<TreeNode<MyData>>
                {
                    new TreeNode<MyData>
                    {
                        Item = new MyData { Name = "22" },
                        Children = new List<TreeNode<MyData>>
                        {
                            new TreeNode<MyData>
                            {
                                Item = new MyData { Name = "DMZ_E (22.3-22.11)"},
                                Children = new List<TreeNode<MyData>>
                                {
                                     new TreeNode<MyData>
                                     {
                                          Item = new MyData { Name = "22.3" },
                                          Children = new List<TreeNode<MyData>>
                                          {
                                              new TreeNode<MyData>{ 
                                                  Item = new MyData{ Name = "22.3.2" }
                                              },
                                              new TreeNode<MyData>
                                              {
                                                  Item = new MyData { Name = "22.3.3"}
                                              },
                                              new TreeNode<MyData>
                                              {
                                                  Item = new MyData { Name = "22.3.4"}
                                              },
                                              new TreeNode<MyData>
                                              {
                                                  Item = new MyData { Name = "22.3.7"}
                                              },
                                              new TreeNode<MyData>
                                              {
                                                  Item = new MyData { Name = "22.3.8"}
                                              },
                                              new TreeNode<MyData>
                                              {
                                                  Item = new MyData { Name = "22.3.9"}
                                              },
                                              new TreeNode<MyData>
                                              {
                                                  Item = new MyData { Name = "22.3.10"}
                                              },
                                              new TreeNode<MyData>
                                              {
                                                  Item = new MyData { Name = "22.3.11"}
                                              }
                                          }
                                     }
                                }
                            }
                        }
                    }
                }
            }
        };
    }

    private async Task ShowLoading()
    {
        Loading = true;

        await Task.Yield();

        Loading = false;
    }

    private OutputLocation getActLocation()
    {
        return Recertification ? OutputLocation.certification : OutputLocation.report;
    }
}
