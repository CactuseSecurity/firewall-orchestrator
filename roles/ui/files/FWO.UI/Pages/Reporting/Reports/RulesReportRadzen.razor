@inject UserConfig userConfig
@using FWO.Report
@using FWO.Ui.Display

<RadzenDataGrid @ref="RulesGrid"
TItem="Rule"
Data="@Rules"
AllowGrouping="false"
ExpandMode="DataGridExpandMode.Multiple"
AllowFiltering="true"
AllowSorting="true">
    <HeaderTemplate>
        <RadzenButton Icon="unfold_more" Size="@ButtonSize.Small" ButtonStyle="@ButtonStyle.Secondary" Variant="@Variant.Flat" />
        <RadzenButton Icon="unfold_less" Size="@ButtonSize.Small" ButtonStyle="@ButtonStyle.Secondary" Variant="@Variant.Flat" />
    </HeaderTemplate>
   @*  <Template Context="Rule">
        <SectionHeader>
            <RulebaseHeader></RulebaseHeader>
        </SectionHeader>
    </Template> *@
    <Columns>
        <RadzenDataGridColumn Visible="true" Width="32px" Groupable="false" Sortable="false" Filterable="false">
            <Template>
                <RadzenStack Orientation="@Orientation.Vertical" Gap="5px" AlignItems="@AlignItems.Center" JustifyContent="@JustifyContent.Center">
                    <RadzenButton Size="@Radzen.ButtonSize.ExtraSmall" Icon="unfold_more" ButtonStyle="@ButtonStyle.Light" Variant="@Variant.Flat" />
                    <RadzenButton Size="@Radzen.ButtonSize.ExtraSmall" Icon="unfold_less" ButtonStyle="@ButtonStyle.Light" Variant="@Variant.Flat" />
                </RadzenStack>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="RulebaseName" Title="Rules" Visible="true">
            <Template>
                <SectionHeader Title="@context.Id.ToString()">
                    <RulebaseHeader Title="@context.DisplayOrderNumberString"></RulebaseHeader>
                </SectionHeader>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    [Parameter]
    public ReportType SelectedReportType { get; set; }

    [Parameter]
    public List<ManagementReport> Managements { get; set; } = new();
    private NatRuleDisplayHtml? RuleDisplay;
    private bool Recertification { get; set; } = false;

    private bool Loading { get; set; }

    #region Radzen UI Boilerplate
    private RadzenDataGrid<Rule> RulesGrid;    
    private bool? GroupsExpanded { get; set; } = false;
    #endregion

    List<Rule> Rules;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await ShowLoading();

        RuleDisplay = new NatRuleDisplayHtml(userConfig);

        var management = Managements.Select(mgt => new ManagementReportController(mgt)).First();
        var device = management.Devices.Select(dev => DeviceReportController.FromDeviceReport(dev)).First();

        var ungroupedRules = ReportRules.GetAllRulesOfGateway(device, management);

        Rules = ungroupedRules.ToList();
    }

    private async Task ShowLoading()
    {
        Loading = true;

        await Task.Yield();

        Loading = false;
    }

    private OutputLocation getActLocation()
    {
        return Recertification ? OutputLocation.certification : OutputLocation.report;
    }
}
