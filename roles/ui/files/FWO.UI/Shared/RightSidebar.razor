@using FWO.Data.Modelling
@using FWO.Data.Report
@using FWO.Report
@using FWO.Report.Filter
@using FWO.Ui.Data
@using System

@inject ApiConnection apiConnection
@inject UserConfig userConfig

<Sidebar Collapsible="true" Resizeable="true" PositionLeft="false" @bind-Width="intWidth">
    <div class="p-3 mt-2">
        <h5 class="text-center">@(userConfig.GetText("objects"))</h5>
        <TabSet @ref="tabset" DarkMode="true" KeepPanelsAlive="true" RsbStyle="true">
            <AnchorNavToRSB @ref="anchorNavToRSB" TabSet="tabset" CollapseState="collapseInRSB" />
            <CascadingValue Value="collapseInRSB">
                <CascadingValue Value="anchorNavToRSB">
                    @if (SelectedReportType.IsDeviceRelatedReport() && AllTabVisible)
                    {
                        <Tab Title="@(userConfig.GetText("all"))" Position=0>
                            <div class="d-md-flex justify-content-md-end sticky-marker-45">
                                <div class="btn btn-secondary btn-sm w-50"
                                    @onclick="@(() => collapseInRSB.Collapse("all"))">@(userConfig.GetText("collapse_all"))
                                </div>
                            </div>
                            <div class="mt-2">
                                <ObjectGroupCollection PageSize="PageSize" FetchObjects="FetchContent" Recert="Recert"
                                    Tab="RsbTab.all" InputDataType="ManagementReport" Data="managementsAllObjects"
                                    NameExtractor="man => man.Name" NetworkObjectExtractor="man => man.Objects"
                                    NetworkServiceExtractor="man => man.Services" NetworkUserExtractor="man => man.Users" />
                            </div>
                        </Tab>
                    }
                    @if (CurrentReport?.ReportData.ManagementData.Count > 0 && (CurrentReport?.ReportType.IsRuleReport()
                                        ?? false))
                    {
                        <Tab Title="@(userConfig.GetText("report"))" StartSelected="true">
                            <div class="d-md-flex justify-content-md-end sticky-marker-45">
                                <div class="btn btn-secondary btn-sm w-50"
                                    @onclick="@(() => collapseInRSB.Collapse("report"))">
                                    @(userConfig.GetText("collapse_all"))</div>
                            </div>
                            <div class="mt-2">
                                <ObjectGroupCollection PageSize="PageSize" FetchObjects="FetchContent" Recert="Recert"
                                    Tab="RsbTab.report" InputDataType="ManagementReport"
                                    Data="managementsReportObjects"
                                NameExtractor="man => man.Name" NetworkObjectExtractor="man => man.ReportObjects"
                                NetworkServiceExtractor="man => man.ReportServices"
                                NetworkUserExtractor="man => man.ReportUsers" />
                            </div>
                        </Tab>
                    }
                    <Tab Title="@(userConfig.GetText("rule"))" @ref="ruleTab">
                        <div class="btn-group btn-group-sm d-md-flex justify-content-md-between sticky-marker-45">
                            <div class="btn btn-dark btn-sm w-50"
                                @onclick="@(async () => { SelectedRules.Clear(); await SelectedRulesChanged.InvokeAsync(SelectedRules); })">
                                @(userConfig.GetText("clear_all"))</div>
                            <div class="btn btn-secondary btn-sm w-50"
                                @onclick="@(() => collapseInRSB.Collapse("rule"))">@(userConfig.GetText("collapse_all"))
                            </div>
                        </div>
                        <div class="mt-2">
                            <ObjectGroupCollection PageSize="PageSize" FetchObjects="FetchContent" Recert="Recert"
                                Tab="RsbTab.rule" StartContentDetailed="true" StartCollapsed="false"
                                InputDataType="Rule"
                                Data="selectedRulesDetailed"
                                NameExtractor=@(rule => $"{rule.DeviceName} - Rule {rule.Id} {rule.Name}")
                                NetworkObjectExtractor="rule => rule.Froms.Select(nl => nl.Object)
                                                                                                                                        .Union(rule.Tos.Select(nl => nl.Object))
                                                                                                                                        .Union(rule.NatData.TranslatedFroms.Select(nl => nl.Object))
                                                                                                                                        .Union(rule.NatData.TranslatedTos.Select(nl => nl.Object)).OrderBy(o => o.Name).ToArray()"
                                NetworkServiceExtractor="rule => rule.Services.Select(sw => sw.Content)
                                                                                                                                        .Union(rule.NatData.TranslatedServices.Select(sw => sw.Content)).OrderBy(s => s.Name).ToArray()"
                                NetworkUserExtractor="rule => rule.Froms.Select(nl => nl.User).Distinct().Where(u => u != null).OrderBy(u => u.Name).ToArray()" />
                        </div>
                    </Tab>
                    @if (CurrentReport?.ReportData.OwnerData.Count > 0 &&
                                        (CurrentReport?.ReportType.IsConnectionRelatedReport() ?? false))
                    {
                        <Tab Title="@(CurrentReport?.ReportType == ReportType.VarianceAnalysis ? userConfig.GetText("modelled_objects") : userConfig.GetText("used_objects"))"
                            StartSelected="true">
                            <div class="d-md-flex justify-content-md-end sticky-marker-45">
                                <div class="btn btn-secondary btn-sm w-50"
                                    @onclick="@(() => collapseInRSB.Collapse("report"))">
                                    @(userConfig.GetText("collapse_all"))</div>
                            </div>
                            <div class="mt-2">
                                <ObjectGroupCollection PageSize="PageSize" FetchObjects="FetchContent" Recert="Recert"
                                    Tab="RsbTab.usedObj" StartCollapsed="false" InputDataType="OwnerConnectionReport"
                                    Data="@(PrepareObjects(CurrentReport?.ReportData.OwnerData ?? new List<OwnerConnectionReport>()))"
                                    NameExtractor="own => own.Name"
                                    NetworkObjectExtractor="own => own.GetAllNetworkObjects(true, userConfig.ResolveNetworkAreas)"
                                    NetworkServiceExtractor="own => own.GetAllServices(true)" />
                                <ObjectGroupCollection PageSize="PageSize" FetchObjects="FetchContent" Recert="Recert"
                                    Tab="RsbTab.usedObj" StartCollapsed="false" InputDataType="GlobalCommonSvcReport"
                                    Data="CurrentReport?.ReportData.GlobalComSvc"
                                    NameExtractor="glbComSvc => glbComSvc.Name"
                                    NetworkObjectExtractor="glbComSvc => glbComSvc.GetAllNetworkObjects(true, userConfig.ResolveNetworkAreas)"
                                    NetworkServiceExtractor="glbComSvc => glbComSvc.GetAllServices(true)" />
                            </div>
                        </Tab>
                    }
                </CascadingValue>
            </CascadingValue>
        </TabSet>
    </div>
</Sidebar>

@code
{
    [CascadingParameter]
    Action<Exception?, string, string, bool> DisplayMessageInUi { get; set; } = DefaultInit.DoNothing;

    [Parameter]
    public int Width { get; set; }

    [Parameter]
    public EventCallback<int> WidthChanged { get; set; }

    [Parameter]
    public ReportBase? CurrentReport { get; set; }

    [Parameter]
    public List<Rule> SelectedRules { get; set; } = [];

    [Parameter]
    public EventCallback<List<Rule>> SelectedRulesChanged { get; set; }

    [Parameter]
    public bool AllTabVisible { get; set; } = true;

    [Parameter]
    public ReportType SelectedReportType { get; set; } = ReportType.Rules;

    [Parameter]
    public TimeFilter LSBTime { get; set; } = new();

    [Parameter]
    public bool Recert { get; set; } = false;

    private FWO.Ui.Shared.TabSet tabset = new();
    private FWO.Ui.Shared.AnchorNavToRSB anchorNavToRSB = new();
    private CollapseState collapseInRSB = new();
    private Tab? ruleTab;

    /// <summary>
    /// List of all managements. Will include detailed objects fetched on demand.
    /// </summary>
    private List<ManagementReport> managementsAllObjects = new();
    /// <summary>
    /// List of managements copied from current report. Will include detailed objects fetched on demand.
    /// </summary>
    private List<ManagementReport> managementsReportObjects = new();
    /// <summary>
    /// List of detailed rules copied from selected rules. Keeps deselected rules cached for the current report.
    /// </summary>
    private List<Rule> selectedRulesDetailed = new();

    private string rsbTimeShortcut = "";
    private string rsbTimeStart = "";
    private string rsbTimeEnd = "";
    private Dictionary<int, long> import_id_start = new(); // import id matching rsbTimeStart for each management
    private Dictionary<int, long> import_id_end = new(); // import id matching rsbTimeEnd for each management
    private List<ManagementReport>? previousReportData = null;
    private HashSet<long> previousSelectedRuleIds = [];

    private int intWidth { get { return Width; } set { Width = value; WidthChanged.InvokeAsync(Width); } }

    private readonly int PageSize = 0;

    protected override async Task OnInitializedAsync()
    {
        if (AllTabVisible)
        {
            setRSBTime();
            await ResetAllTabMgts();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        bool timeChanged = setRSBTime();
        if (AllTabVisible && timeChanged)
            await ResetAllTabMgts();
        if (CurrentReport?.ReportData.ManagementData != previousReportData)
        {
            previousReportData = CurrentReport?.ReportData.ManagementData;
        }
        if (SelectedReportType.IsRuleReport())
        {
            ResetReportState();
        }
        SyncSelectedRulesDetailed();
        UpdateRuleTabSelection();
    }

    public void ResetReportState()
    {
        managementsReportObjects = new();
        foreach (ManagementReport mgt in CurrentReport?.ReportData.ManagementData ?? new List<ManagementReport>())
        {
            if (HasReportTabData(mgt))
            {
                managementsReportObjects.Add(new() { Id = mgt.Id, Name = mgt.Name });
            }
        }
        if (managementsReportObjects.Count == 0 && CurrentReport?.ReportData.ManagementData.Count > 0)
        {
            managementsReportObjects = CurrentReport.ReportData.ManagementData
                .Select(mgt => new ManagementReport { Id = mgt.Id, Name = mgt.Name })
                .ToList();
        }
    }

    private void SyncSelectedRulesDetailed()
    {
        Dictionary<long, Rule> detailedById = selectedRulesDetailed
            .GroupBy(rule => rule.Id)
            .ToDictionary(group => group.Key, group => group.First());
        List<Rule> nextRules = new();

        foreach (Rule rule in SelectedRules)
        {
            if (detailedById.TryGetValue(rule.Id, out Rule? detailed))
            {
                detailed.Name = rule.Name;
                detailed.MgmtId = rule.MgmtId;
                detailed.DeviceName = rule.DeviceName;
                detailed.RulebaseName = rule.RulebaseName;
                nextRules.Add(detailed);
            }
            else
            {
                nextRules.Add(new Rule(rule));
            }
        }

        selectedRulesDetailed = nextRules;
    }

    private void UpdateRuleTabSelection()
    {
        HashSet<long> currentRuleIds = SelectedRules
            .Select(rule => rule.Id)
            .ToHashSet();
        if (currentRuleIds.SetEquals(previousSelectedRuleIds))
        {
            return;
        }

        previousSelectedRuleIds = currentRuleIds;
        if (currentRuleIds.Count > 0 && ruleTab != null)
        {
            tabset.SetActiveTab(ruleTab);
        }
    }

    private static bool HasReportTabData(ManagementReport managementReport)
    {
        if (managementReport.ReportedRuleIds.Count > 0)
        {
            return true;
        }
        if (managementReport.RuleStatistics.ObjectAggregate.ObjectCount > 0)
        {
            return true;
        }
        if (managementReport.Rulebases.Any(rb => rb.Rules.Length > 0))
        {
            return true;
        }
        return managementReport.Devices.Any(dev => dev.RulebaseLinks != null && dev.RulebaseLinks.Any());
    }

    private async Task ResetAllTabMgts()
    {
        try
        {
            import_id_start = await GetImportIds(rsbTimeStart);
            import_id_end = await GetImportIds(rsbTimeEnd);
            Dictionary<string, object> queryVars = new()
            {
                [QueryVar.Limit] = 1,
                [QueryVar.Offset] = 0,
                [QueryVar.ImportIdStart] = import_id_start.Values.Any(v => v > 0) ? import_id_start.Values.Where(v => v > 0).Min() : 0,
                [QueryVar.ImportIdEnd] = import_id_end.Values.Max(),
            };
            var mgmResponse = await apiConnection.SendQuerySafeAsync<List<ManagementReport>>(ObjectQueries.getAllObjectDetails,
            queryVars);
            if (!TryGetResult(mgmResponse, userConfig.GetText("object_fetch"), out var mgmResult))
            {
                return;
            }
            managementsAllObjects = mgmResult.Where(m => m.Objects.Count() > 0 || m.Services.Count() > 0 || m.Users.Count() >
            0).ToList();
            collapseInRSB.Collapse("all");
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("object_fetch"), "", true);
        }
    }

    private bool setRSBTime()
    {
        string prevStart = rsbTimeStart;
        string prevEnd = rsbTimeEnd;

        if (SelectedReportType.IsRuleReport())
        {
            if (LSBTime.IsShortcut)
            {
                if (rsbTimeShortcut == LSBTime.TimeShortcut)
                    return false;
                rsbTimeStart = DateTime.Now.ToString(DynGraphqlQuery.fullTimeFormat);
                rsbTimeShortcut = LSBTime.TimeShortcut;
            }
            else
            {
                rsbTimeStart = LSBTime.ReportTime.ToString(DynGraphqlQuery.fullTimeFormat);
                rsbTimeShortcut = "";
            }

            rsbTimeEnd = rsbTimeStart;
        }
        else if (SelectedReportType.IsChangeReport())
        {
            (rsbTimeStart, rsbTimeEnd) = DynGraphqlQuery.ResolveTimeRange(LSBTime);
        }

        return prevStart != rsbTimeStart || prevEnd != rsbTimeEnd;
    }

    private async Task<Dictionary<int, long>> GetImportIds(string time)
    {
        Dictionary<string, object> queryVars = new()
        {
            [QueryVar.Time] = time != "" ? time : DateTime.Now.ToString(DynGraphqlQuery.fullTimeFormat),
        };
        var response = await apiConnection.SendQuerySafeAsync<List<ManagementReport>>(ReportQueries.getRelevantImportIdsAtTime, queryVars);
        if (!TryGetResult(response, userConfig.GetText("object_fetch"), out var result))
        {
            return new Dictionary<int, long>();
        }
        Dictionary<int, long> importIds = new();
        foreach (ManagementReport mgm in result)
        {
            long superManagerImportId = mgm.SuperManagerId != null
                ? result.FirstOrDefault(m => m.Id == mgm.SuperManagerId)?.Import.ImportAggregate.ImportAggregateMax.RelevantImportId ?? 0
                : 0;
            importIds[mgm.Id] = Math.Max(
                mgm.Import.ImportAggregate.ImportAggregateMax.RelevantImportId ?? 0,
                superManagerImportId
            );
        }
        return importIds;
    }

    public async Task FetchContent(RsbTab rsbTab, ObjCategory objType, Func<Task> hasChangedCallback, long id = 0, bool nat = false)
    {
        Log.WriteDebug("Fetching Content..", $"nat: {nat}");

        try
        {
            switch (rsbTab)
            {
                case RsbTab.all:
                    await FetchAllTabContent(objType, hasChangedCallback, id);
                    break;

                case RsbTab.report:
                    await FetchReportTabContent(objType, hasChangedCallback, id);
                    break;

                case RsbTab.rule:
                    await FetchRuleTabContent(objType, hasChangedCallback, id, nat);
                    break;
            }
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("object_fetch"), "", true);
        }
    }

    private async Task FetchAllTabContent(ObjCategory objType, Func<Task> hasChangedCallback, long id)
    {
        var mgt = managementsAllObjects.FirstOrDefault(m => m.Id == id);
        if (mgt == null) return;

        if (objType == ObjCategory.all)
            mgt.Detailed = [true, true, true];
        else
            mgt.Detailed[(int)objType - 1] = true;

        var queryVars = new Dictionary<string, object>
        {
            { QueryVar.Limit, userConfig.ElementsPerFetch },
            { QueryVar.Offset, 0 },
            { QueryVar.ManagementId, (int)id },
            { QueryVar.ImportIdStart, import_id_start.GetValueOrDefault((int)id, 0) },
            { QueryVar.ImportIdEnd, import_id_end.GetValueOrDefault((int)id, 0) }
        };

        string query = objType switch
        {
            ObjCategory.all => ObjectQueries.getAllObjectDetails,
            ObjCategory.nobj => ObjectQueries.getNetworkObjectDetails,
            ObjCategory.nsrv => ObjectQueries.getNetworkServiceDetails,
            ObjCategory.user => ObjectQueries.getUserDetails,
            _ => ""
        };

        await FetchObjects(query, queryVars, async managementsUpdate =>
        {
            var mgtUpdated = managementsUpdate.ManagementData.FirstOrDefault(m => m.Id == id);
            if (mgtUpdated != null)
            {
                if (objType == ObjCategory.all || objType == ObjCategory.nobj)
                {
                    mgt.Objects = mgtUpdated.Objects;
                    mgt.ReportObjects = mgtUpdated.ReportObjects;
                }
                if (objType == ObjCategory.all || objType == ObjCategory.nsrv)
                {
                    mgt.Services = mgtUpdated.Services;
                    mgt.ReportServices = mgtUpdated.ReportServices;
                }
                if (objType == ObjCategory.all || objType == ObjCategory.user)
                {
                    mgt.Users = mgtUpdated.Users;
                    mgt.ReportUsers = mgtUpdated.ReportUsers;
                }
            }
            await hasChangedCallback();
        });
    }

    private async Task FetchReportTabContent(ObjCategory objType, Func<Task> hasChangedCallback, long id)
    {
        var mgtReport = managementsReportObjects.FirstOrDefault(m => m.Id == id);
        if (mgtReport == null) return;

        if (objType == ObjCategory.all)
            mgtReport.Detailed = [true, true, true];
        else
            mgtReport.Detailed[(int)objType - 1] = true;

        var queryVars = new Dictionary<string, object>
        {
            { QueryVar.Limit, userConfig.ElementsPerFetch },
            { QueryVar.Offset, 0 },
            { QueryVar.MgmIds, (int)id }
        };
        if (import_id_start.TryGetValue((int)id, out var importStart))
        {
            queryVars[QueryVar.ImportIdStart] = importStart;
        }
        if (import_id_end.TryGetValue((int)id, out var importEnd))
        {
            queryVars[QueryVar.ImportIdEnd] = importEnd;
        }

        bool gotAllObjects = await CurrentReport!.GetObjectsForManagementInReport(
            queryVars, objType,
            userConfig.AutoFillRightSidebar ? int.MaxValue : userConfig.MaxInitialFetchesRightSidebar,
            apiConnection,
            async managementsUpdate =>
            {
                var mgtUpdated = managementsUpdate.ManagementData.FirstOrDefault(m => m.Id == id);
                if (mgtUpdated != null)
                {
                    if (objType == ObjCategory.all || objType == ObjCategory.nobj)
                        mgtReport.ReportObjects = mgtUpdated.ReportObjects;

                    if (objType == ObjCategory.all || objType == ObjCategory.nsrv)
                        mgtReport.ReportServices = mgtUpdated.ReportServices;

                    if (objType == ObjCategory.all || objType == ObjCategory.user)
                        mgtReport.ReportUsers = mgtUpdated.ReportUsers;
                }
                await hasChangedCallback();
            }
        );

        if (!gotAllObjects)
        {
            DisplayMessageInUi(null, userConfig.GetText("object_fetch_warning"), userConfig.GetText("E0021"), true);
        }
    }

    private async Task FetchRuleTabContent(ObjCategory objType, Func<Task> hasChangedCallback, long id, bool nat)
    {
        var rule = selectedRulesDetailed.FirstOrDefault(r => r.Id == id);
        if (rule == null)
        {
            return;
        }
        if (rule.Detailed)
        {
            return; // already fetched
        }

        var queryVars = new Dictionary<string, object>
        {
            { QueryVar.Limit, userConfig.ElementsPerFetch },
            { QueryVar.Offset, 0 },
            { QueryVar.ImportIdStart, import_id_start.GetValueOrDefault((int)rule.MgmtId, 0) },
            { QueryVar.ImportIdEnd, import_id_end.GetValueOrDefault((int)rule.MgmtId, 0) },
            { QueryVar.RuleId, id }
        };

        string query = nat ? RuleQueries.getNatRuleDetails : RuleQueries.getRuleDetails;

        try
        {
            var rulesResponse = await apiConnection.SendQuerySafeAsync<List<Rule>>(query, queryVars);
            if (!TryGetResult(rulesResponse, userConfig.GetText("object_fetch"), out var rules))
            {
                return;
            }
            Rule? ruleUpdated = rules.FirstOrDefault(r => r.Id == id);
            if (ruleUpdated == null)
            {
                DisplayMessageInUi(null, userConfig.GetText("object_fetch"), "", true);
                return;
            }

            rule.Froms = rule.Froms.Concat(ruleUpdated?.Froms ?? []).ToArray();
            rule.Tos = rule.Tos.Concat(ruleUpdated?.Tos ?? []).ToArray();
            rule.NatData.TranslatedFroms = rule.NatData.TranslatedFroms.Concat(ruleUpdated?.NatData.TranslatedFroms ??
            []).ToArray();
            rule.NatData.TranslatedTos = rule.NatData.TranslatedTos.Concat(ruleUpdated?.NatData.TranslatedTos ?? []).ToArray();
            rule.Services = rule.Services.Concat(ruleUpdated?.Services ?? []).ToArray();
            rule.NatData.TranslatedServices = rule.NatData.TranslatedServices.Concat(ruleUpdated?.NatData.TranslatedServices ??
            []).ToArray();

            rule.Detailed = true;

            await hasChangedCallback();
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("object_fetch"), "", true);
        }
    }

    private async Task FetchObjects(string query, Dictionary<string, object> queryVars, Func<ReportData, Task> callback)
    {
        // lazy fetch all objects for right sidebar
        try
        {
            ReportData reportData = new();
            bool keepFetching = true;
            int fetchCount = 0;
            int elementsPerFetch = userConfig.ElementsPerFetch;

            while (keepFetching && (++fetchCount <= userConfig.MaxInitialFetchesRightSidebar || userConfig.AutoFillRightSidebar))
            {
                var response = await apiConnection.SendQuerySafeAsync<List<ManagementReport>>(query, queryVars);
                if (!TryGetResult(response, userConfig.GetText("object_fetch"), out var managementsCurrentFetch))
                {
                    break;
                }
                if (fetchCount == 1)
                {
                    reportData.ManagementData = managementsCurrentFetch;
                }
                else
                {
                    (bool newObjects, Dictionary<string, int> maxAddedCounts) = reportData.ManagementData.Merge(managementsCurrentFetch);
                    // new objects might have been added, but if none reached the limit of elementsPerFetch, we can stop fetching
                    keepFetching = newObjects && maxAddedCounts.Values.Any(v => v >= elementsPerFetch);
                }

                if (queryVars.ContainsKey(QueryVar.Offset))
                    queryVars[QueryVar.Offset] = (int)queryVars[QueryVar.Offset] + elementsPerFetch;
                await callback(reportData);
            }

            Log.WriteDebug("Lazy Fetch", $"Fetched sidebar objects in {fetchCount - 1} cycle(s) ({elementsPerFetch} at a time)");

            if (fetchCount > userConfig.MaxInitialFetchesRightSidebar && !userConfig.AutoFillRightSidebar)
                DisplayMessageInUi(null, userConfig.GetText("object_fetch_warning"), userConfig.GetText("E0021"), true);
        }
        catch (Exception exception)
        {
            DisplayMessageInUi(exception, userConfig.GetText("object_fetch"), "", true);
        }
    }

    private List<OwnerConnectionReport> PrepareObjects(List<OwnerConnectionReport> ownerData)
    {
        if (CurrentReport?.ReportType == ReportType.VarianceAnalysis)
        {
            List<OwnerConnectionReport> ownerDataForRsb = [];
            foreach (var ownerReport in ownerData)
            {
                ownerDataForRsb.Add(ReportVariances.CollectObjectsInReport(ownerReport));
            }
            return ownerDataForRsb;
        }
        return ownerData;
    }

    private bool TryGetResult<T>(ApiResponse<T> response, string action, [System.Diagnostics.CodeAnalysis.NotNullWhen(true)] out T? result)
    {
        if (response.HasErrors)
        {
            string errorMessage = response.Errors != null ? string.Join(Environment.NewLine, response.Errors) : "";
            DisplayMessageInUi(null, action, errorMessage, true);
            result = default;
            return false;
        }

        if (response.Result == null)
        {
            DisplayMessageInUi(null, action, userConfig.GetText("E0001"), true);
            result = default;
            return false;
        }

        result = response.Result;
        return true;
    }
}
