@using FWO.Data.Report
@using FWO.Ui.Display
@inject UserConfig userConfig

@typeparam TItem

<table class="tree-table">
    <thead>
        <tr>
            <th @onclick="() => SortBy(nameof(Rule.Name))">
                Name
                @if(SortColumn == nameof(Rule.Name))
                {
                    <span class="sort-icon @(SortAscending ? "oi oi-caret-bottom" : "oi oi-caret-top")"></span>
                }
            </th>
            <th @onclick="() => SortBy(nameof(Rule.OrderNumber))">
                @(userConfig.GetText("number"))
                @if(SortColumn == nameof(Rule.OrderNumber))
                {
                    <span class="sort-icon @(SortAscending ? "oi oi-caret-bottom" : "oi oi-caret-top")"></span>
                }
            </th>
            <th>
                @(userConfig.GetText("source_zone"))
            </th>
            <th>
                @(userConfig.GetText("source"))
            </th>
            <th>
                @(userConfig.GetText("destination_zone"))
            </th>
            <th>
                @(userConfig.GetText("destination"))
            </th>
            <th>
                @(userConfig.GetText("services"))
            </th>
            <th>
                @(userConfig.GetText("action"))
            </th>
            <th>
                @(userConfig.GetText("track"))
            </th>
            <th>
                @(userConfig.GetText("enabled"))
            </th>
            <th>
                @(userConfig.GetText("uid"))
            </th>
            <th>
                @(userConfig.GetText("comment"))
            </th>
        </tr>
    </thead>
    <tbody>
        @if(SortedNodes is not null)
        {
            @foreach(TreeNode<TItem> node in SortedNodes)
            {
                <TreeTableRow TItem="TItem" Node="node" Level="0" CellTemplate="CellTemplate" OnToggle="ToggleNode" RuleDisplay="RuleDisplay" />
            }
        }
    </tbody>
</table>

@code {
    [Parameter]
    public List<string> Columns { get; set; } = new();

    [Parameter]
    public List<TreeNode<TItem>> Nodes { get; set; } = new();

    [Parameter]
    public RenderFragment<TItem> CellTemplate { get; set; }

    [Parameter]
    public Action<TreeNode<TItem>> OnToggle { get; set; }

    private string SortColumn { get; set; } = nameof(Rule.RulebaseId);
    private bool SortAscending { get; set; } = true;

    private NatRuleDisplayHtml? RuleDisplay;

    protected override void OnInitialized()
    {
        RuleDisplay = new NatRuleDisplayHtml(userConfig);
    }

    private IEnumerable<TreeNode<TItem>> SortedNodes =>
        SortNodes(Nodes);

    private void SortBy(string column)
    {
        if(SortColumn == column)
            SortAscending = !SortAscending;
        else
        {
            SortColumn = column;
            SortAscending = true;
        }
    }

    private IEnumerable<TreeNode<TItem>> SortNodes(IEnumerable<TreeNode<TItem>> nodes)
    {
        if(typeof(TItem) == typeof(Rule))
        {
            if(SortColumn == nameof(Rule.Name))
            {
                return SortAscending
                    ? nodes.OrderBy(n => ((Rule)(object)n.Item).Name)
                    : nodes.OrderByDescending(n => ((Rule)(object)n.Item).Name);
            }
            else if(SortColumn == nameof(Rule.OrderNumber))
            {
                return SortAscending
                    ? nodes.OrderBy(n => ((Rule)(object)n.Item).OrderNumber)
                    : nodes.OrderByDescending(n => ((Rule)(object)n.Item).OrderNumber);
            }
        }
        return nodes;
    }

    private void ToggleNode(TreeNode<TItem> node)
    {
        node.IsExpanded = !node.IsExpanded;
    }

    private MarkupString SortingIcon()
    {
        return new MarkupString($@"<span class=""{(SortAscending ? "oi oi-caret-bottom" : "oi oi-caret-top")}""></span>");
    } 
}
