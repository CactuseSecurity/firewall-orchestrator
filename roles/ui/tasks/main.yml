
- block:
    - name: initialize handler for datarecovery
      set_fact:
        ui_handler_guard: start
      changed_when: true
      notify:
      - ui handler
      when: installation_mode == "upgrade"

    - name: check for ui dir
      stat:
        path: "{{ fworch_home }}/ui"
      register: ui_dir_check

    - name: backup ui dir
      synchronize:
        src: "{{ fworch_home }}/ui"
        dest: "{{ fworch_home }}/backup_ui"
      delegate_to: "{{ inventory_hostname }}"
      when: ui_dir_check.stat.exists and installation_mode == "upgrade"

    - name: create ui dir
      file:
        dest: "{{ ui_dir }}"
        state: directory
        owner: "{{ fworch_user }}"
        group: "{{ fworch_group }}"

    - name: copy ui files to frontend target
      synchronize:
        src: "FWO.UI"
        dest: "{{ ui_dir }}"
        rsync_opts:
          - "--delete"
          - "--chown={{ fworch_user }}:{{ fworch_group }}"
      register: ui_sync_result
      tags: [ 'test' ]

    - name: track ui deployment changes
      set_fact:
        ui_deploy_changed: "{{ ui_sync_result.changed or installation_mode == 'new' }}"

  become: true

- include_tasks: ui_apache_install_and_setup.yml

- include_tasks: install_and_run_ui_service.yml

- name: include upgrade script
  import_tasks: run-upgrades.yml
  when: "installation_mode == 'upgrade'"

- name: finalize handler for datarecovery
  set_fact:
    ui_handler_guard: stop
  changed_when: true
  notify: "ui handler"
  when: installation_mode == "upgrade"
